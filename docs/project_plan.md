# 项目全景规划文档 (Project Master Plan)

> **最后更新**: 2026-01-11
> **当前版本**: v2.1 (MVP 已完成)
> **部署状态**: Cloudflare Pages (已就绪)

---

## 1. 项目概况 (Project Overview)

**3rd_MC** 是一个基于 WebGL 的第三人称动作冒险体验项目，旨在展示 **Minecraft (MC) 风格** 的视觉美学与 **魂类 (Souls-like)** 硬核战斗机制的结合。本项目作为正式游戏的预热入口，利用现代 Web 技术 (Three.js + Vue 3) 提供无缝的网页端体验。

### 1.1 核心价值
*   **视觉风格**: 独特的 MC 像素风与现代光影渲染结合。
*   **核心玩法**: 多世界传送门探索 + 实时锁定动作战斗。
*   **技术演示**: 验证 Three.js 在高性能 Web 游戏场景中的可行性。

### 1.2 技术栈
*   **构建工具**: Vite
*   **前端框架**: Vue 3 (负责 UI/HUD)
*   **3D 引擎**: Three.js
*   **样式库**: TailwindCSS
*   **状态管理**: Pinia (配合 mitt 事件总线)
*   **着色器**: GLSL (vite-plugin-glsl)
*   **物理/碰撞**: 自定义轻量级碰撞系统
*   **部署平台**: Cloudflare Pages

---

## 2. 产品需求与核心体验 (PRD Highlights)

详细需求请参考 [PRD.md](./PRD.md)。

### 2.1 体验流程
`加载页` → `超平坦世界 (Hub)` → `传送门选择` → `地牢探索 (Dungeon)` → `Boss/精英战` → `通关展示`

### 2.2 关键系统
1.  **超平坦世界 (Hub)**:
    *   基于 Perlin 噪音生成的草坪地形。
    *   包含 3 个风格迥异的传送门（使用 Shader 特效）。
    *   Fog2 雾效营造氛围。
2.  **地牢探索**:
    *   线性长廊结构。
    *   可互动物体（宝箱、机关），具备视觉描边与按键提示。
3.  **魂类战斗系统**:
    *   **锁定机制**: 鼠标中键锁定敌人，镜头跟随。
    *   **动作模组**: 普通攻击 (连击)、重攻击 (蓄力)、格挡 (防御)。
    *   **反馈**: 伤害飘字、屏幕震动、受击红闪。
4.  **UI/HUD**:
    *   **3D 血量**: 心形模型显示。
    *   **体力条**: 限制连续行动。
    *   **小地图**: 实时显示地形与位置。

---

## 3. 技术架构 (Technical Architecture)

### 3.1 目录结构
```bash
d:\Code\3rd_MC\
├── src\
│   ├── assets\          # 静态资源 (字体、图标)
│   ├── components\      # Vue UI 组件 (Crosshair, MiniMap, HUD, CTA)
│   ├── js\              # 核心逻辑
│   │   ├── camera\      # 相机控制 (CameraRig)
│   │   ├── components\  # 3D 对象组件 (TextMeshes, FloatingItems)
│   │   ├── config\      # 配置文件 (Player, Chunk, Shadow)
│   │   ├── interaction\ # 交互逻辑 (Raycaster, Selection)
│   │   ├── tools\       # 工具库 (Noise, RNG, DOM)
│   │   ├── utils\       # 通用工具 (Input, Time, Resources, EventBus)
│   │   ├── world\       # 游戏世界管理
│   │   │   ├── player\  # 玩家控制器 (Animation, Movement, Collision)
│   │   │   ├── terrain\ # 地形系统 (Generator, ChunkManager)
│   │   │   └── ...
│   │   ├── experience.js # 游戏主循环单例
│   │   └── renderer.js   # Three.js 渲染器配置
│   ├── shaders\         # GLSL 着色器
│   └── ...
├── public\              # 公共资源 (模型 glb, 纹理 png)
└── docs\                # 项目文档
```

### 3.2 核心模块设计
1.  **Experience 单例**:
    *   作为全局入口，管理 `Time`, `Sizes`, `Camera`, `Renderer`, `World`, `Resources` 等核心实例。
2.  **地形数据系统 (Terrain Data System)**:
    *   **TerrainDataManager**: 统一管理地形数据（高度、颜色）。
    *   **InstancedMesh**: 优化地形方块渲染，替代传统的 Geometry 合并。
    *   **MiniMap**: 基于数据源生成的 Canvas2D 小地图。
3.  **玩家控制器 (Player Controller)**:
    *   状态机驱动 (Idle, Walk, Run, Attack, Block)。
    *   混合动画系统 (Animation Blending)。

---

## 4. 开发规划 (Development Roadmap)

### 4.1 当前进度
- [x] **基础框架搭建**: Vite + Three.js + Vue 环境。
- [x] **部署流程**: Cloudflare Pages 自动化部署配置。
- [x] **文档体系**: PRD, 目录规范, 开发规范。

### 4.2 迭代里程碑

#### 发布里程碑 (面向用户体验)
*   **MVP (P0)**：可完成 1 个地牢闭环（Hub → 传送 → 探索/战斗 → 通关 CTA → 返回 Hub）。
*   **内容版 (P1)**：3 个地牢可进入；每个地牢 2~3 个互动点；战斗与 UI 体验稳定。
*   **打磨版 (P2)**：性能、音效、反馈与加载体验完善；可对外稳定分发。

#### 迭代节奏
*   建议按 **1 周 / 迭代** 推进；每个迭代必须产出一个“可部署、可演示”的版本。

### 4.3 迭代计划（结合第七章初稿）

| 迭代 | 目标 | 主要交付物 |
|------|------|------------|
| I0 基线 | 形成可持续开发与演示的最小闭环 | 场景状态机骨架、加载过渡、关键输入映射、可部署演示页 |
| I1 世界基建 | 完成 Hub 的高性能地形与小地图 | TerrainDataManager、InstancedMesh 地形、MiniMap（Canvas2D） |
| I2 Hub + 传送门 | Hub 可玩：边界约束 + 3 传送门切换 | 传送门 Shader、门框资源、碰撞触发、世界切换管理 |
| I3 地牢探索 | 地牢场景可跑通探索与互动 | 50m 长廊地牢、可互动物体、提示与故事弹窗、返回 Hub |
| I4 战斗 MVP | 实现魂类锁定与基础动作战斗 | 锁定系统、敌人（1v1）、攻击/格挡/受击反馈、死亡/重生 |
| I5 UI + CTA | 完整 HUD 与转化闭环 | 3D 心形血量、体力条、怪物血条 Billboard、CTA 弹窗 |
| I6 打磨优化 | 对外发布质量提升 | 性能优化、资源压缩/懒加载、音效与反馈打磨、缺陷清零 |

#### I0 基线（可部署可演示）
*   验收口径
    *   [ ] Hub 场景可进入，基础相机/移动可用
    *   [ ] 进入传送门时有加载过渡占位（先无内容也可）
    *   [ ] 线上部署可访问（Cloudflare Pages）

#### I1 世界基建（Terrain Data System）
*   依赖：[`terrain_data_system_cedd794c.plan.md`](./terrain_data_system_cedd794c.plan.md)
*   验收口径
    *   [ ] Hub 地形规模达到 100×100 量级，视觉呈现具备水/沙/草/雪分段
    *   [ ] InstancedMesh 渲染链路跑通（不回退到逐块 Mesh）
    *   [ ] MiniMap 显示并能反映地形色块与玩家位置

#### I2 Hub + 传送门（世界切换闭环）
*   验收口径
    *   [ ] Hub 原点附近有 3 个传送门，触发准确
    *   [ ] 传送门入口 Shader 正常渲染且性能可接受
    *   [ ] 玩家离开传送门阵过远时边界约束生效（软/硬均可）
    *   [ ] 完成 Hub → 进入目标世界 的切换（先 1 个地牢也可）

#### I3 地牢探索（互动与返回）
*   验收口径
    *   [ ] 地牢场景可加载，至少 1 个 50m 线性长廊可走通
    *   [ ] 每个地牢至少 2 个可互动物体（描边/自发光 + 按键提示）
    *   [ ] 触发互动后镜头拉近 + 弹窗展示图文；游戏暂停/恢复正确
    *   [ ] 地牢终点可返回 Hub

#### I4 战斗 MVP（锁定与反馈）
*   验收口径
    *   [ ] 准星对准怪物 + 鼠标中键可锁定/解除锁定
    *   [ ] 锁定时 VFX 生效：准星动画、怪物描边、脚底光圈、屏幕暗角
    *   [ ] 玩家轻击连段、重击、格挡的基础判定可用
    *   [ ] 伤害飘字、受击红闪/震动同步；死亡/重生流程可用

#### I5 UI + CTA（体验与转化闭环）
*   验收口径
    *   [ ] 玩家 3D 心形血量模型正确渲染并绑定数值变化
    *   [ ] 体力条消耗/恢复正常，限制连续行动
    *   [ ] 怪物头顶血条 Billboard 正常显示
    *   [ ] 通关后 CTA 弹窗触发、可关闭并返回继续探索

#### I6 打磨优化（发布质量）
*   验收口径
    *   [ ] 资源加载与切换无明显卡顿（可用懒加载/预加载策略改善）
    *   [ ] 核心流程无阻塞缺陷（Hub/传送/地牢/战斗/返回/CTA）
    *   [ ] 音效与关键反馈补齐（攻击/命中/受击/通关）

### 4.4 全局验收口径（跨迭代）
*   目标平台：PC Chrome；最低分辨率 1380×840
*   核心流程：Hub → 地牢 → 通关 → 返回 Hub 全程可走通
*   性能底线：Hub（100×100 量级方块）与战斗场景不出现明显掉帧/冻结

### 4.5 风险与依赖
*   传送门 Shader：跨设备兼容性与性能波动，需要提供降级方案（简化特效或降低分辨率）
*   InstancedMesh 地形：颜色更新与分块策略是性能关键，需要预留优化迭代
*   动画与判定：战斗手感高度依赖动画资源与判定时序，需要尽早做出可玩的 MVP

---

## 5. 部署与运维 (Deployment)

### 5.1 Cloudflare Pages 配置
*   **Git 仓库**: `keithhegit/3rd_MC`
*   **构建命令**: `npm run build`
*   **输出目录**: `dist`
*   **Node 版本**: >= 18.0.0 (已在 package.json 中锁定)

### 5.2 常用命令
*   `npm run dev`: 启动本地开发服务器。
*   `npm run build`: 生产环境构建。
*   `npm run preview`: 预览构建产物。

---

## 6. 开发规范 (Development Guidelines)

### 6.1 代码风格
*   遵循 ESLint + Prettier 配置。
*   组件命名: PascalCase (如 `MiniMap.vue`)。
*   JS 类文件: kebab-case (如 `terrain-manager.js`)。

### 6.2 资源管理
*   模型: 使用 `.glb` 格式 (Draco 压缩)。
*   纹理: 尽量使用 `.webp` 或压缩后的 `.png`。
*   路径: 统一在 `src/js/sources.js` 中声明资源引用。

### 6.3 Git 工作流
*   **分支策略**:
    *   `master`: 主分支，对应生产环境。
    *   `feature/*`: 功能开发分支。
    *   `fix/*`: Bug 修复分支。
*   **Commit 规范**: 遵循 Conventional Commits (如 `feat: add terrain system`, `fix: camera lag`).



### 7. 初稿

仔细阅读并分析这三份文档后，我可以非常确定的告诉你：**这是一个单一项目的完整设计方案。**

这三份文档分别代表了该项目的 **“过去（头脑风暴）”**、**“现在（产品定义）”** 和 **“正在进行的未来（技术实施）”**。

为了帮你彻底找回记忆，我将通过 **“记忆唤醒”**、**“整合版 PRD”** 和 **“完整开发计划”** 三个部分来为你梳理。

------

### 🧠 第一部分：记忆唤醒 —— 这是个什么项目？

**一句话概括**：这是一个 **“Minecraft 的皮，黑暗之魂的骨”** 的 Web 端（Three.js）3D 动作游戏体验站。

它的用途：

不仅仅是一个 Demo，而是你设想中某款正式游戏的 预热宣发入口。用户在网页里体验硬核战斗，通关后弹出 CTA（Call to Action）引导关注。

**三份文档的拼图关系**：

1. **`cursor_.md` (前世/设计原点)**：这是你与 AI 的 **头脑风暴记录**。
   - *关键记忆*：你在这个阶段推翻了最初的“回合制”想法，决定改为 **“实时动作战斗”**（左键连击、中键锁定）。你还确定了“多世界”设定，即从一个超平坦世界通过传送门进入地牢。
2. **`PRD.md` (今生/产品蓝图)**：这是基于讨论定稿的 **需求文档**。
   - *关键记忆*：它规定了具体的 UI 细节（如 **3D 心形血条**）、交互方式（物体描边+弹窗）以及商业目的（通关后弹出“敬请期待”）。
3. **`terrain_data_system...plan.md` (肉体/当前断点)**：这是针对 **“初始世界（Hub World）”** 的 **深度技术方案**。
   - *关键记忆*：**这是你上次停工的地方**。你当时觉得简单的平面太无聊，所以设计了一套基于 **FBM 噪音** 的地形系统，并计划用 **InstancedMesh** 来优化渲染，还准备做一个 **Vue 小地图**。

------

### 📘 第二部分：整合版 PRD (完整产品需求文档)

我将技术方案融入产品需求，为你整理了这份最终执行版 PRD。

#### 1. 产品概述

- **项目名称**：Soul-Voxel Experience (魂类方块世界预热站)
- **核心体验**：在 MC 风格的程序化世界中探索 → 穿越传送门 → 在地牢中进行硬核 1v1 战斗 → 通关预热。
- **技术栈**：Vite + Three.js + Vue 3 + Pinia + InstancedMesh。

#### 2. 核心场景与流程

##### 2.1 初始场景：Hub 大厅 (技术重难点)

*此部分融合了 `terrain` 文档的技术细节。*

- **场景构成**：由大量方块组成的程序化地形，配合 Fog2 雾效。
- **地形生成技术**：
  - **数据源**：`TerrainDataManager` 类，使用 **FBM (分形布朗运动) 噪声** 生成高度图。
  - **生物群系分层**：
    - `Height <= -0.2` → **水** (蓝色)
    - `-0.2 < H <= 0` → **沙** (黄色)
    - `0 < H <= 0.8` → **草** (绿色)
    - `H > 0.8` → **雪** (白色)
  - **渲染优化**：使用 **InstancedMesh** 批量渲染 100x100 规模的方块，确保 Web 端 60fps。
- **导航 UI**：屏幕左上角悬浮 **MiniMap (Vue组件)**，通过 Canvas2D 读取地形数据，实时绘制 2D 俯视图并标记玩家位置。
- **传送门**：原点附近有 3 个 **紫色黑曜石风格传送门**，入口使用 Shader 制作空间扭曲特效。

##### 2.2 核心玩法：地牢探索与战斗

- **地牢环境**：进入传送门后加载独立场景，均为 50 米长的线性长廊。
- **叙事互动**：
  - 场景中有发光描边的物体（宝箱、遗迹）。
  - 靠近显示 CSS2D 提示 (按E)，触发后镜头拉近，弹出 Vue 图文故事卡片（游戏暂停）。
- **战斗系统 (Souls-like)**：
  - **操作**：WASD 移动，左键轻击（连段），右键重击（蓄力），C 键格挡，Space 翻滚。
  - **锁定机制**：按 **鼠标中键** 锁定敌人。
    - *视觉反馈*：屏幕四周出现 **Vignette 暗角**，怪物轮廓变红，脚下出现 **脉冲光圈 (Pulsating)**。
    - *相机行为*：视角自动修正，始终将玩家和敌人同框。
  - **UI 表现**：
    - 玩家血条：屏幕底部中央的 **3D 实体心形模型 (Heart.glb)**，随血量减少而破碎/变暗。
    - 怪物血条：头顶 3D Billboard。

##### 2.3 商业闭环

- **通关判定**：击败地牢 Boss 或到达终点。
- **CTA**：弹出模态框显示“敬请期待”及游戏宣传图，关闭后可继续探索其他世界。

------

### 🚀 第三部分：整合开发计划 (Master Roadmap)

根据你的 `terrain` 计划断点，我重新梳理了开发顺序。**建议你直接从第一阶段开始复工，先把那个地形做出来。**

#### 🟢 阶段一：世界基建 (World Infrastructure) —— *当前断点*

*目标：完成 terrain_data_system 计划中未完成的任务，搭建高性能 Hub 世界。*

1. **噪声工具库** (Pending):
   - [ ] 创建 `src/js/tools/noise.js`，移植 Perlin/FBM 算法。
2. **地形数据管理** (Pending):
   - [ ] 实现 `TerrainDataManager` 类，生成 `{x, y, z, height, color}` 数据块。
   - [ ] 实现高度到颜色的映射逻辑（水->沙->草->雪）。
3. **实例化渲染** (Critical):
   - [ ] 重构 `Terrain.js`，抛弃旧的 Mesh 方案，改用 `InstancedMesh` 渲染 100x100 方块。
4. **小地图组件**:
   - [ ] 开发 `MiniMap.vue`，读取 DataManager 数据在 Canvas 上绘制像素地图。

#### 🟡 阶段二：角色与传送 (Character & Portal)

*目标：让玩家能动，能穿越。*

1. **角色控制器**:
   - [ ] 导入 Steve 模型与动画 (Idle/Run)。
   - [ ] 实现角色与地形高度图的物理碰撞（让角色能走在起伏的方块上）。
2. **传送门系统**:
   - [ ] 制作黑曜石门框模型。
   - [ ] 移植 Shadertoy 的 Portal Shader 到 Three.js。
   - [ ] 实现场景切换管理器（卸载 Terrain，加载 Dungeon）。

#### 🔴 阶段三：战斗核心 (Combat System) —— *重难点*

*目标：实现 PRD 里的硬核战斗手感。*

1. **锁定系统**:
   - [ ] 实现射线检测与摄像机锁定逻辑 (LookAt)。
   - [ ] 制作 VFX：锁定准星动画、怪物红色描边、脚底光圈、屏幕暗角。
2. **动作系统**:
   - [ ] 接入攻击（轻/重）、受击、死亡、格挡动画。
   - [ ] 实现简单的 Combo 连击判定与伤害飘字。
3. **UI 挂载**:
   - [ ] 制作并导入 **3D 心形血量模型**，绑定玩家 HP 数据。

#### 🔵 阶段四：打磨与发布 (Polish)

1. **叙事系统**: 开发 Vue 弹窗组件与互动检测。
2. **音频**: 接入 Suno AI 生成的 BGM。
3. **商业化**: 开发 CTA 弹窗与埋点（可选）。

------

💡 建议下一步行动：

你的代码库里应该已经有了 terrain_data_system...plan.md 这个文件。请直接按照该文件中的 TODO 列表开始工作，先搞定 noise.js 和 TerrainDataManager，这是整个项目的基石。

---

## 8. 基于当前代码库的执行计划（可直接开工）

> **说明**：本节用于把“文档规划”落到“当前仓库可迭代的任务单”。
> 以 `new_dev` 分支当前实现为基准：Hub + 传送门 + 地牢探索闭环已跑通；战斗系统尚未进入 MVP。

### 8.1 当前完成度对照（截至 2026-01-12）

**已实现（可演示）**
*   Hub：可移动、边界约束、3 传送门触发与加载过渡
*   地牢：线性长廊、3 个互动点（提示+弹窗）、阅读进度 HUD、出口返回 Hub
*   体验打磨：互动弹窗可用 ESC/E/点击遮罩关闭；完成后提示与出口文案；R 快速返回；完成状态按传送门持久化并反馈到 Hub

**未实现（下一迭代核心）**
*   战斗：锁定、敌人 AI、攻击/格挡/受击、死亡/重生、战斗 HUD
*   通关：Boss/精英战、通关 CTA 弹窗
*   音效：BGM/关键 SFX（攻击/命中/受击/通关）

### 8.2 迭代拆分建议（P4-P6 / I4-I6）

#### I4 / P4：战斗 MVP（锁定 + 1v1 可打）

**目标**
*   在地牢中生成 1 个敌人并可完成 1v1 战斗闭环：锁定 → 攻击/格挡 → 受击反馈 → 死亡/重生

**交付物（按实现顺序）**
1.  **敌人基础体（可被锁定）**
    *   敌人实体（Mesh/简单动画占位）+ 位置/朝向 + 生命周期
    *   地牢内固定刷怪点（建议放在长廊中段/终点前）
2.  **锁定系统（鼠标中键）**
    *   选中目标 + 锁定/解除锁定
    *   锁定时相机/角色朝向跟随（最小可用即可）
    *   视觉反馈：准星变化、敌人描边/脚底环（二选一先做）
3.  **玩家战斗输入与判定**
    *   轻击（左键）/重击（右键）/格挡（C）接入
    *   最小伤害判定（距离+角度阈值或简化 hitbox）
4.  **受击与死亡**
    *   玩家/敌人 HP 数值与扣血
    *   受击反馈（红闪/震动/飘字，先做其中 1 个）
    *   死亡/重生：玩家死亡回到地牢入口点（或直接回 Hub，二选一）

**验收口径**
*   进入任意地牢后，能稳定触发 1 次战斗，并完整结束（击败敌人或玩家死亡）
*   不出现输入锁死/无法退出/无法继续操作的问题

#### I5 / P5：UI + CTA（完整转化闭环）

**目标**
*   通关后弹出 CTA，形成“可对外演示的商业闭环”

**交付物**
*   玩家血量与体力 UI（可先用 2D 条占位，后续再替换 3D 心形）
*   敌人血条 Billboard（锁定或进入战斗范围时显示）
*   Boss/精英判定（可先用“终点刷 1 只加强怪”代替）
*   通关 CTA Modal：文案 + 链接/二维码位 + 可关闭并返回 Hub

**验收口径**
*   Hub → 地牢 → 战斗通关 → CTA → 返回 Hub 全流程可稳定跑通

#### I6 / P6：打磨优化（对外发布质量）

**目标**
*   把“可玩”提升为“可稳定分发”

**交付物**
*   音频：BGM + 关键 SFX
*   加载：切换世界时资源预加载/占位动画稳定
*   性能：地牢/战斗不出现明显卡顿（包含 CF 环境）
*   缺陷清零：输入、暂停、弹窗、返回等关键流程不阻塞

### 8.3 建议工作节奏（每迭代 1 周）

*   周一：拆任务 + 定验收口径（以本节为基线）
*   周二-四：实现（保证每天都有可部署版本）
*   周五：回归测试 + CF 验证 + 缺陷清零

### 8.4 本仓库回归命令（每次迭代必跑）

*   `npm run lint`
*   `npm run build`
*   `npx playwright test`
