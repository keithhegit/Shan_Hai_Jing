# Pokemon GDD（迭代：搜打撤融合 + UI/UX 升级）

更新时间：2026-01-20

## 0. 口径与入口

- 工程唯一口径：`docs/master_plan.md`
- 本文定位：本次迭代的设计拆解与验收口径（面向实现）

关键入口（以仓库现状为准）：

- World：`src/js/world/world.js`
- Player：`src/js/world/player/player.js`
- NPC（敌人/动物）：`src/js/world/enemies/humanoid-enemy.js`
- 资源清单：`src/js/sources.js`

## 0.1 当前实现状态（用于对齐验收与后续迭代）

已实现并回归通过（Playwright 覆盖）：

- Hub 流程可跑通；B 打开背包；靠近仓库按 E 打开仓库
- 物质枪：背包内可装备/收起；挂载到主控；射线起点来自枪口（muzzle）
- 锁定：中键锁定/解除（Hub 动物与 Dungeon 敌人）；锁定时主控朝向会平滑对齐目标
- 物质枪 DoT：锁定且开火时持续扣血；命中后目标进入仇恨追击并可近战攻击
- 地牢：固定 4 个战斗房间（fight1-4）；总敌人 4 杂兵 + 1 Boss；杂兵击败会掉落金币并可拾取入背包
- 地牢出口：出口点有明显可视标记，并做了清障，避免被墙体挡住

未实装或未形成闭环（需要后续切片）：

- 捕捉闭环：已有“Q 引导捕捉 → 直接入背包”的原型，但缺少“地面生成可拾取战利品 + 撤离结算”的完整链路
- 网格背包（Tetris Inventory）：基础网格/拖拽/旋转/持久化已做，但占格规则需要扩展到更多道具（不再是全 1 格）
- 负重视觉化：已有背部挂载与基础惩罚，但缺少 Boss 罐的超大占格与更明确的高亮表达
- “参考图 1-5 号类”的房间配置：需要以图中编号规则作为房间/事件的生成口径

## 1. 本迭代目标

在不改变既有“Hub ↔ Dungeon”闭环的前提下，将核心体验改写为“搜打撤 + 魂类锁定决斗”的融合：备战 → 潜入 → 决斗 → 捕捉 → 撤离，并配套升级 UI/UX 为更拟物化、更沉浸、更少 2D HUD 占比的风格。

## 2. 需求拆解

### 2.1 主控换模与动作对齐

目标：

- 将主控模型替换为 `Character_Male_1.gltf`
- 从其 animations 列表中，匹配并覆盖现有主控所有动作（locomotion / jump / falling / standup / punch / block）

边界：

- 若新模型缺少某些动作，允许做最小可用的降级映射（例如缺少左右方向走路时，复用 Walk 作为四向）

验收口径：

- Hub 与 Dungeon 中，主控可正常移动/跑/蹲、可跳跃、Z/X 拳击与 C 格挡不报错、不会因模型结构差异崩溃

### 2.2 物质枪道具：`material_gun`（当前绑定 `Tools/heart.glb`）

目标：

- `material_gun` 作为“物质枪”道具进入背包体系
- 玩家打开背包点击该道具后，主控手持该武器
- 举枪姿势：优先使用主控模型动画 `holding-both` 的静态 Pose（若缺失则回退到 `wave` 最后一帧）
- “枪”语义：它是一块水晶；射线/激光从水晶枪口发射

交互协议：

- UI：背包条目提供“装备/卸下”
- World：响应装备事件，将武器挂到主控右手（或可用手部骨骼）

验收口径：

- 装备后可见武器模型且尺寸接近“枪”
- 卸下后武器消失
- 装备状态下主控保持举枪姿态（holding-both 优先），且不阻断基础移动动画
- 激光/射线起点来自水晶枪口（muzzle），而非主控身体中心点

### 2.3 锁定 + 激光弹道 + 持续伤害

目标：

- 当主控手持物质枪且锁定目标（动物/敌人）时，枪口到目标之间持续显示激光弹道
- 命中目标后持续扣血（攻击力设为最低）

规则：

- 仅在“已装备物质枪 + 已锁定目标”时生效
- 伤害方式为 DoT（每帧或定频扣血）
- 命中反馈至少包含：激光可见、目标血条下降

验收口径：

- 可稳定锁定一个目标并看到激光线
- 目标血量随时间下降，最终可触发死亡逻辑（若目标支持死亡）

### 2.4 仇恨与 NPC 攻击 + 数值管理表

目标：

- 任何被物质枪攻击的目标会进入仇恨状态：跑向主控并尝试攻击
- 所有 NPC 具备攻击主控的能力（近身攻击）
- 数值集中管理：HP/攻击力/攻击范围/追击距离/移动速度
- 强度梯度：鸡最低攻击和 HP 最弱，狼最高

数值承接：

- 新增“数值管理表”，由 World 在生成 NPC 时注入（hp）并在 AI 更新时引用（伤害、追击/攻击距离）

验收口径：

- 鸡/狼在相同逻辑下表现出明显强弱差异（HP 与伤害）
- 被激光打到的目标会更积极追击并攻击主控

### 2.5 锁定原型规格（对齐 cursor\_.md）

本节用于把“战斗与锁定系统”从讨论态收敛为可实现的规格，作为后续战斗 MVP 与 VFX 的验收口径。

行为与触发：

- 怪物行为：固定位置等待玩家靠近
- 锁定方式：准星对准 + 鼠标中键锁定/解除
- 脱离规则：不做战斗区域封锁，允许跑开脱离战斗
- 战斗形式：实时动作战斗
- 战斗规模：1v1 单挑

锁定视觉（UI/VFX）：

- 锁定准星：圆圈收缩动画
- 被锁定目标：红色高亮（材质发光倾向/描边倾向，至少要可感知）
- 被锁定目标：脚底光幕圈（红色圆环），持续 pulsate
- 被锁定目标：头顶显示血条（仅在锁定时显示）
- 锁定状态：屏幕暗角（vignette），用于强化“已锁定”的状态识别

当前实现（对照）：

- 中键锁定/解除：已实装；并且不再因拾取/交互提示而失效
- 脚底红色圆环：已实装（锁定时显示）
- 头顶血条：已实装（锁定时显示）
- 镜头与转向：已实装（相机与主控朝向会对齐锁定目标）
- Vignette / 锁定准星圆圈收缩 / 红色高亮：未统一落地（可作为下一轮增强项）

镜头与转向（锁定模式）：

- 锁定时，相机 Rig 朝向敌人，并将注视点设置为“玩家与敌人中点 + 目标高度偏移”
- 锁定时，World 会持续将主控朝向平滑对齐目标，减少空挥

结束表现：

- 怪物死亡：播放死亡动画后消失

验收口径（最小）：

- 装备物质枪后，可见武器模型且不影响基础移动
- 锁定成功时，准星与目标的锁定反馈可被明确感知
- 目标死亡后，不保留锁定状态与锁定 UI/VFX 残留

## 3. 数据设计

### 3.1 道具定义（最小）

| 字段        | 说明                             | 示例           |
| ----------- | -------------------------------- | -------------- |
| itemId      | 背包内 ID（尽量与资源 key 对齐） | `material_gun` |
| resourceKey | three resources key              | `material_gun` |
| type        | 道具类型                         | `weapon`       |
| equipSlot   | 装备槽                           | `right_hand`   |

### 3.2 NPC 数值表（最小字段）

最小字段集合：

- `maxHp`
- `attackDamage`
- `aggroRange`
- `attackRange`
- `moveSpeed`

初始强度梯度（仅用于本迭代验收）：

- 鸡：最低 `maxHp` 与 `attackDamage`
- 狼：最高 `maxHp` 与 `attackDamage`

## 4. 事件与状态

### 4.1 事件（UI → World）

- `inventory:equip`：{ itemId }
- `input:lock_on`：鼠标中键触发锁定/解除（由 InputManager 广播）
- `combat:toggle_lock`：锁定目标的 Object3D（由 World 广播给相机 Rig）
- `combat:lock` / `combat:lock_clear`：锁定提示与 UI 状态（由 World 广播给 UI/后处理）

### 4.2 World 状态（最小）

- `equippedItemId`：当前装备道具（仅实现物质枪）
- `lockedTarget`：当前锁定目标（动物/敌人）
- `laser`：激光线可视对象与命中状态

## 5. 迭代顺序（Implementation Order）

1. 主控换模与动作对齐（确保不崩溃 + 基础移动/战斗输入可用）
2. 背包内新增物质枪道具 + 装备/卸下 + 持枪 Pose
3. 锁定目标扩展到 Hub 动物与 Dungeon 敌人
4. 激光弹道可视化 + DoT 持续扣血
5. NPC 仇恨与攻击逻辑统一，并接入数值表

## 6. 回归口径

- 流程回归：加载 → Hub → 进地牢 → 出地牢
- 交互回归：B/H 打开背包/仓库；装备/卸下物质枪；中键锁定/解除；激光伤害与仇恨追击
- 地牢回归：房间可连通到 Boss 与出口；至少 4 杂兵 + 1 Boss；出口标记可见且不被墙体遮挡

## 7. 验收走查清单（快速）

1. Hub 中装备 `material_gun` 后，水晶挂到右手，尺寸正常；主控保持 holding-both Pose（移动时权重降低但不突兀）
2. 中键锁定最近目标：相机进入锁定镜头，目标脚下出现红色圆环，屏幕出现暗角
3. 锁定时目标头顶显示血条；解除锁定时血条隐藏、暗角消失、圆环隐藏
4. 锁定目标死亡：自动解除锁定，不残留锁定视觉

## 8. 搜打撤融合（The Extraction Twist）

### 8.1 核心循环（The Loop）

将“搜打撤”的核心紧张感嵌入现有 Hub ↔ Dungeon 结构中，循环拆解为：

1. 备战（Base）：在 Hub 基地进行生产与整理，积累粮食、收容罐（Canister）、升级材料等
2. 潜入（Infiltration）：通过传送门进入线性地牢或开放地图
3. 决斗（Duel）：发现稀有怪 → 强制锁定（Lock-on）→ 1v1 拼刀将其削弱至可捕捉阈值
4. 捕捉（Capture）：目标虚弱 → 激光牵引（站桩风险）→ 目标转化为实体战利品
5. 撤离（Extraction）：背负战利品（负重惩罚 + 视觉高亮）→ 规避敌人 → 进入传送门结算

关键约束：

- 捕捉不是战斗的结束，而是风险的开始（带负重撤离才是结算点）
- 捕捉过程在代码层面是“Entity → Item → 视觉特效 → 仓库”的状态转换链

### 8.2 捕捉即“处决”（The Tether Mechanic）

捕捉是一个高风险的引导（Channeling）过程，核心变量与状态机如下。

#### 前置条件（Check）

- 目标血量阈值：`TargetHP / TargetMaxHP < 15%`
- 目标硬直状态：`TargetState == Stunned`

#### 输入（Input）

- 玩家按住 `Q` 键进入捕捉引导

#### 引导状态（Channeling）

- Lock：玩家移动为 0；强制面向目标
- Visual：创建 Beam（光束）连接“枪口”与“怪物核心”
- Duration：持续 4.0 秒
- Interrupt：监听玩家受到伤害；一旦玩家掉血，立即中断引导，目标回血 10%

#### 转化（Transformation）

- 引导成功后，地面生成一个收容罐（Canister）模型：
  - 资产：`public/models/Environment/crystal3.glb`
  - 语义：实体战利品（可拾取/可背负/可入仓库）

### 8.3 负重与视觉化（Burden & Visualization）

目标：把负重后“背负战利品”的压力，显式体现在移动/冲刺/可见性上，并用 3D 方式表达，而不是堆更多 2D HUD。

#### 收容罐规格（待你确认）

| CanisterSize | 来源 | 背包占用（Grid） | 负重惩罚            | 视觉挂载（Visuals） |
| ------------ | ---- | ---------------: | ------------------- | ------------------- |
| Small        | 杂兵 |              2x2 | 无                  | 腰带后方            |
| Medium       | 精英 |              2x2 | 移速 -10%           | 背包侧面挂载        |
| Large        | Boss |              4x4 | 移速 -25%（禁冲刺） | 背部高亮挂载        |

本节实现依赖项（当前缺失）：

- 可触发的捕捉产出：地牢内生成 Canister，并能进入背包/仓库
- 背包“占格”模型：否则无法对齐 Small/Medium/Large 的格子语义

当前实现（对照）：

- 捕捉产出：已实装（捕捉成功后在地面生成可拾取的收容罐战利品；拾取时若背包放不下会提示并保持掉落）
- 负重惩罚：已实装（中/大收容罐会影响移速与冲刺）
- 3D 视觉挂载：已实装（方案 A：背部挂载并堆叠显示；当前外观使用 Crystal 模型资源占位）
- 背包占格：已实装（8x6 网格、支持拖拽与旋转，可配置物品尺寸）

下一轮需要补齐的“闭环”差异（你现在感知到的缺失点主要在这里）：

- Canister 目前只区分 Small/Medium/Large 三个道具 ID，没有进一步细分“Boss 专属罐”的外观层差异（可后置）
- 捕捉过程缺少进度 UI（读条/取消提示），失败原因也没有可视化（当前仅提供条件满足时的提示语）

#### 视觉策略（不做结论，列候选实现口径）

- 方案 A：将 Canister 作为 3D 模型挂到玩家骨骼/背部挂点，并允许堆叠显示
- 方案 B：不挂到骨骼，改为玩家头顶“战利品队列”漂浮堆叠（更易读，但更游戏化）

堆叠规则（意图）：

- 若已有 Canister，新 Canister 沿玩家背向（局部 Z）向外偏移，形成“叠罗汉”效果

## 9. UI/UX：沉浸式设计（Diegetic Interface）

目标：降低“手游感”，减少 2D HUD 占比，让 UI 成为世界的一部分（拟物化/3D 化/贴合角色）。

### 9.1 3D 拟物化状态栏（The Heart Meter）

用一颗真实跳动的心脏代替平面血条。

#### 设计变量（待你确认）

- 资产：`Heart.glb`（你目前提到的“Low Poly 风格”心脏）
- 频率：`BPM = 60 + (100 - CurrentHP) * 2`（此公式是否以 100 为满血上限，需要你确认当前工程 HP 标度）
- 低血量阈值：`HP < 30%` 时切换“破碎/黑暗”贴图，并触发相机抖动

#### 实现口径（Web 对应点，需你确认取舍）

- 渲染容器：在 HUD 内渲染一个独立的 3D 视口（副相机 + 单独 scene），输出到 UI 容器
- 动画驱动：按帧更新时间（等价于 RenderStepped），用正弦缩放/材质切换/抖动控制

### 9.2 网格背包系统（Tetris Inventory）

目标：将“取舍”作为搜打撤的核心体验：当玩家拾取 2x2 的收容罐但背包满时，必须通过移动/旋转/丢弃来腾挪。

#### 数据结构（The Grid Model）

- `GridCols = 8`, `GridRows = 6`
- `Cells[x][y]`：存储 `ItemID | null`
- `Items[itemInstanceId]`：记录物品矩形信息 `{ itemId, w, h, x, y, rot }`

#### 交互逻辑（Interaction）

- Drag：拖拽物品跟随鼠标
- Ghost Preview：网格上显示半透明影子
  - 绿色：`CanFit()` 为 true
  - 红色：`CanFit()` 为 false（越界或重叠）
- Rotate：拖拽时按 `R` 交换宽高（并影响 `CanFit()`）

当前实现（对照）：

- 网格渲染：已实装（B 打开背包后显示 8x6 网格）
- 拖拽与旋转：已实装（拖拽摆放；拖拽中按 R 旋转）
- Ghost Preview：已实装（绿色/红色可放置提示）
- 不规则形状：已实装（网格边角不可用格）
- 物品 SVG/图标：已实装（金币/钥匙/收容罐/物质枪）
- 布局持久化：已实装（摆放位置会随存档保存与加载）

#### 约束（需你确认）

- 物品是否区分“堆叠数量”（例如 1x1 的材料可叠加）与“不可叠加的实体”（例如 Canister）
- 背包与仓库是否都改为网格，还是仅背包网格、仓库保持列表

### 9.3 先把占格做成“可调的规则”，再谈具体数值（你给的尺寸方案在这里落地）

本节的目标是：让占格不再是“每个道具都 1 格”，而是由一个可扩展的规格表驱动。实现时不需要改 UI 交互（拖拽/旋转/预览/持久化沿用现有），只需要让 World 的 `itemSizes` 覆盖更多道具。

#### 9.3.1 物品分两类：堆叠（Stack）与实例（Instance）

- 堆叠（Stack）：数量叠加，默认在列表区显示 `xN`，网格里只放 1 个“代表格”
  - 例：金币、材料、钥匙（如果你愿意也可以把钥匙做成 Instance）
- 实例（Instance）：每一个都是独立实体，需要占格、能旋转、能丢弃、能作为掉落物
  - 例：物质枪、收容罐、宝箱掉落的剑/镐/斧

推荐：钥匙先做 Stack（体验更顺），等你确认要“钥匙也占空间压力”再切 Instance。

#### 9.3.2 推荐占格（你的想法泛化后的第一版）

背包基准：`8x6`（带不规则 Mask），允许旋转。

| 类别            | 示例 itemId                                    | 建议占格 (w×h) | 是否允许旋转 | 备注                                                              |
| --------------- | ---------------------------------------------- | -------------: | :----------: | ----------------------------------------------------------------- |
| 货币            | `coin`                                         |            1×1 |      否      | Stack，网格里只放 1 个代表格                                      |
| 钥匙            | `key_plains` 等                                |            1×2 |      是      | 若保持 Stack，则网格代表格 1×2；若改 Instance，则每把钥匙单独占格 |
| 武器（主手）    | `material_gun`                                 |            2×4 |      是      | 你的设想：视觉上更像“长物件”                                      |
| 工具/武器掉落   | `Sword_*` / `Axe_*` / `Pickaxe_*` / `Shovel_*` |            2×4 |      是      | 第一版统一 2×4，后续再区分长短                                    |
| 灵兽罐（常规）  | `canister_small` / `canister_medium`           |            2×2 |      是      | 把“抓到一只怪”的空间压力做得更明显                                |
| Boss 罐（超大） | `canister_large`（或新增 `canister_boss`）     |            4×4 |      否      | 推荐不允许旋转（减少“摆法花活”带来的学习成本）                    |

你后续如果要增加“稀有武器更长/更大”的表达，只需要在这张表里改一行，不需要改 UI。

#### 9.3.3 背包满了怎么办：让规则决定结果

当拾取/捕捉产出一个物品时：

- 若是 Stack：按堆叠规则进入背包（不占新增格，或只占代表格）
- 若是 Instance：必须能在网格里找到可放置位置（允许旋转）才进入背包
- 放不下：掉落在地（或自动入仓库，取决于你想要“搜打撤压力”还是“便捷”）

推荐：地牢内优先掉落在地；Hub 内可配置为自动入仓库（降低挫败感）。

## 10. 迭代版本计划（vNext）

本节仅做“版本切片与验收口径”的拆分，不在此做实现方案定案。若其中任何切片与你的优先级不一致，请你直接调整顺序或删改。

### 10.1 版本切片

#### vNext-A：Extraction 闭环（最小可玩）

- 目标：Hub 备战 → 进地牢 → 决斗削弱 → Q 引导捕捉 → 生成 Canister → 撤离结算（回到 Hub）
- 必须打通的状态链：`Entity(怪物)` → `Captured(Item)` → `WorldDrop(可拾取)` → `Inventory(网格占用)` → `Warehouse/结算`
- 失败/中断路径：引导中受击中断（玩家掉血）→ 捕捉失败 → 目标回血 10% → 可再次进入决斗

#### vNext-B：负重表达（惩罚 + 视觉）

- 目标：背负 Canister 后，移速/冲刺规则生效；Canister 可视化挂载可被清晰识别
- 验收重点：玩家在撤离路上“更难逃”，且队友/旁观者一眼能看出负重状态

#### vNext-C：UI/UX 拟物化升级（先做心脏，再做网格背包）

- 目标：Heart Meter 3D 化（跳动/低血量破碎/抖动）；背包切换为网格拖拽 + 旋转
- 风险点：网格背包的拖拽与数据持久化、与现有背包系统的兼容层

### 10.2 关键待确认（需要你拍板，不在本文代你定）

1. HP 标度：`CurrentHP` 与满血基准是 5/10/100 还是别的？（关系到 BPM 与阈值）
2. 捕捉触发：`TargetState == Stunned` 的“硬直”定义来源（战斗系统里哪个状态能作为判据）
3. Beam 语义：捕捉 Beam 与现有“物质枪激光 DoT”的 Beam 是否复用同一个渲染对象/管线
4. Canister 资产：`crystal3.glb` 的最终路径与命名是否固定（以及是否需要 Small/Medium/Large 三种外观）
5. 网格背包范围：只改背包，还是背包+仓库一起改；是否允许材料堆叠
